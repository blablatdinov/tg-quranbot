# Руководство по миграции рассылок с Python на Elixir

Это руководство поможет вам перейти с Python-версии QuranBot на Elixir-версию для рассылок с параллельной обработкой сообщений.

**Важно**: Elixir-версия предназначена только для рассылок. Обработка сообщений пользователей остается на Python.

## Основные различия

### Архитектура

| Аспект | Python | Elixir |
|--------|--------|--------|
| **Параллелизм** | Последовательная обработка в цикле | `Task.async_stream/3` для параллельной обработки |
| **Обработка ошибок** | Try/catch в каждой итерации | Автоматическая обработка в `Task.async_stream/3` |
| **Планировщик** | Внешний планировщик (cron) | Встроенный планировщик в `GenServer` |
| **Мониторинг** | Базовое логирование | Подробные метрики и счетчики |
| **Назначение** | Обработка сообщений + рассылки | Только рассылки |

### Производительность

Elixir-версия обеспечивает значительное улучшение производительности для рассылок:

- **Параллельная отправка**: Вместо последовательной отправки сообщений всем пользователям, Elixir отправляет их параллельно
- **Настраиваемый параллелизм**: Можно настроить количество одновременных запросов
- **Автоматическое восстановление**: Система автоматически обрабатывает ошибки и продолжает работу

## Пошаговая миграция

### 1. Подготовка окружения

```bash
# Установка Elixir
brew install elixir  # macOS
# или
sudo apt-get install elixir  # Ubuntu

# Проверка версии
elixir --version
```

### 2. Настройка проекта

```bash
# Клонирование репозитория
git clone <repository>
cd quranbot

# Установка зависимостей
mix deps.get

# Настройка базы данных
mix ecto.create
mix ecto.migrate
```

### 3. Конфигурация

Создайте файл `.env`:

```bash
TELEGRAM_TOKEN=your_telegram_bot_token
DATABASE_URL=postgresql://user:password@localhost/quranbot
REDIS_URL=redis://localhost:6379
DAILY_AYATS=on
DAILY_PRAYERS=on
RAMADAN_MODE=false
LOG_LEVEL=info
POOL_SIZE=10
```

### 4. Запуск приложения

```bash
# Для разработки
mix run --no-halt

# Для продакшена
MIX_ENV=prod mix release
./_build/prod/rel/quran_bot/bin/quran_bot start
```

## Сравнение кода

### Python (последовательная обработка)

```python
# Python версия - последовательная обработка
unsubscribed_users = []
for answer, chat_id in self._zipped_ans_chat_ids(rows):
    await self._iteration(answer, chat_id, unsubscribed_users)
```

### Elixir (параллельная обработка)

```elixir
# Elixir версия - параллельная обработка
active_users
|> Task.async_stream(&send_morning_content/1, 
    max_concurrency: 10, 
    timeout: 30_000)
|> process_results()
```

## Преимущества Elixir-версии

### 1. Производительность

- **Ускорение в 5-10 раз** при большом количестве пользователей
- **Меньшая нагрузка на сервер** благодаря эффективному использованию ресурсов
- **Лучшая масштабируемость** для роста пользовательской базы

### 2. Надежность

- **Автоматическое восстановление** после ошибок
- **Graceful degradation** при проблемах с сетью
- **Детальное логирование** всех операций

### 3. Мониторинг

- **Встроенные метрики** для отслеживания производительности
- **Счетчики успешных/неуспешных отправок**
- **Интеграция с Prometheus** для визуализации

### 4. Удобство разработки

- **Функциональный подход** упрощает тестирование
- **Pattern matching** для обработки различных типов ошибок
- **Hot code reloading** для быстрой разработки

## Интеграция с Python-версией

### Совместная работа

1. **Python-версия**: Обрабатывает сообщения пользователей, команды, callback queries
2. **Elixir-версия**: Выполняет только рассылки с параллельной обработкой

### Общая база данных

Обе версии используют одну и ту же базу данных PostgreSQL:
- Таблица `users` - информация о пользователях
- Таблица `ayats` - аяты для рассылки
- Таблица `prayers` - время намаза
- Таблица `suras` - информация о сурах

### Запуск

```bash
# Запуск Python-версии (обработка сообщений)
python src/main.py

# Запуск Elixir-версии (рассылки)
mix run --no-halt
```

## Тестирование производительности

Запустите демонстрацию для сравнения производительности:

```bash
elixir examples/parallel_mailing_demo.exs
```

Ожидаемые результаты:
- **Последовательная обработка**: ~10 секунд для 100 пользователей
- **Параллельная обработка**: ~1-2 секунды для 100 пользователей
- **Ускорение**: 5-10x

## Мониторинг и метрики

### Встроенные метрики

Elixir-версия предоставляет следующие метрики:

- `quranbot_messages_sent_total` - общее количество отправленных сообщений
- `quranbot_messages_failed_total` - количество неуспешных отправок
- `quranbot_users_unsubscribed_total` - количество отписавшихся пользователей
- `quranbot_mailing_duration_seconds` - время выполнения рассылки

### Настройка Grafana

1. Откройте Grafana (http://localhost:3000)
2. Добавьте Prometheus как источник данных
3. Создайте дашборд с метриками QuranBot

## Troubleshooting

### Частые проблемы

1. **Ошибки подключения к БД**
   ```bash
   # Проверьте настройки DATABASE_URL
   mix ecto.reset
   ```

2. **Ошибки Telegram API**
   ```bash
   # Проверьте TELEGRAM_TOKEN
   # Убедитесь, что бот не заблокирован
   ```

3. **Проблемы с Redis**
   ```bash
   # Проверьте подключение к Redis
   redis-cli ping
   ```

### Логи

Проверьте логи для диагностики проблем:

```bash
# В режиме разработки
mix run --no-halt

# В продакшене
tail -f logs/quranbot.log
```

## Заключение

Миграция рассылок на Elixir обеспечивает:

- ✅ **Значительное улучшение производительности рассылок**
- ✅ **Лучшую надежность и отказоустойчивость**
- ✅ **Удобный мониторинг и метрики**
- ✅ **Простое масштабирование**
- ✅ **Совместимость с существующей Python-версией**

Для получения дополнительной помощи обратитесь к документации или создайте issue в репозитории. 